// ====================================================================
// 03_DATA_PROCESSOR.GS - CORRIGIDO
// Processamento direto para agregação (SEM aba Geral)
// ====================================================================

const DataProcessor = {
  
  /**
   * Processa pedidos e gera agregação direta (SEM gravar na aba Geral)
   * - modoAditivo: true para processamento incremental (soma valores), false para reprocessamento completo
   */
  processarPedidos: function(pedidos, config, modoAditivo = true) {
    if (!pedidos || pedidos.length === 0) {
      return { novos: 0, atualizados: 0, ignorados: 0 };
    }
    
    Logger.registrar('INFO', config.nomeEmpresa, config.alias,
      `Processando ${pedidos.length} pedidos para agregação direta (modo: ${modoAditivo ? 'INCREMENTAL' : 'COMPLETO'})`, {});
    
    // 1. Eliminar duplicação por pedido.id
    const pedidosUnicos = this.eliminarDuplicacao(pedidos);
    
    Logger.registrar('INFO', config.nomeEmpresa, config.alias,
      `Pedidos únicos após deduplicação: ${pedidosUnicos.length}`, {});
    
    
    // 2. Calcular totais agregados em memória
const dadosAgregados = this.calcularTotaisAgregados(pedidosUnicos, config);

    // 3. Processar agregação nas abas das empresas COM modo aditivo
Aggregator.processarDadosAgregados(config.abaDestino, dadosAgregados, modoAditivo);

Logger.registrar('SUCESSO', config.nomeEmpresa, config.alias,
  'Processamento direto concluído', 
  { pedidos_processados: pedidosUnicos.length });
    
    return { 
      novos: pedidosUnicos.length, 
      atualizados: 0, 
      ignorados: pedidos.length - pedidosUnicos.length 
    };
  },
  
  /**
   * Elimina duplicação por pedido.id (múltiplos itens do mesmo pedido)
   */
  eliminarDuplicacao: function(pedidos) {
    const pedidosMap = new Map();
    
    pedidos.forEach(pedido => {
      const id = pedido.id;
      if (!pedidosMap.has(id)) {
        pedidosMap.set(id, pedido);
      }
    });
    
    return Array.from(pedidosMap.values());
  },
  
  /**
   * Calcula totais agregados por mês/alias em memória
   */
  calcularTotaisAgregados: function(pedidos, config) {
    const agregadosPorMes = new Map();
    
    pedidos.forEach(pedido => {
      const status = Utilitarios.normalizarStatus(pedido.status);
      
      // Filtrar apenas status válidos
if (!Aggregator.isStatusValido(status)) {
  return;
}
      
      const dataString = Utilitarios.extrairDataYampi(pedido.created_at); // "2025-07-15"
      const [ano, mes] = dataString.split('-');
      const chaveData = `${ano}-${mes}-01`;
      
      if (!agregadosPorMes.has(chaveData)) {
        agregadosPorMes.set(chaveData, {
          data: chaveData,
          nomeEmpresa: config.nomeEmpresa,
          alias: config.alias,
          receitaVendas: 0,
          descontosConcedidos: 0,
          jurosVendas: 0
        });
      }
      
      const agregado = agregadosPorMes.get(chaveData);
      
      const valueProducts = parseFloat(pedido.value_products) || 0; 
      const valueShipment = parseFloat(pedido.value_shipment) || 0;
      const valueDiscount = parseFloat(pedido.value_discount) || 0;
      const valueTax = parseFloat(pedido.value_tax) || 0;
      
      // Fórmulas corretas
      agregado.receitaVendas += (valueProducts + valueShipment); 
      agregado.descontosConcedidos += valueDiscount;
      agregado.jurosVendas += valueTax;
    });
    
    return Array.from(agregadosPorMes.values());
  },
  
/**
 * Busca pedidos específicos para auditoria (aba Pesquisa) - VERSÃO COM ORDENAÇÃO
 */
buscarPedidosParaPesquisa: function(alias, token, secretKey, mesAno) {
  try {
    const [mes, ano] = mesAno.split('/');
    const dataInicio = `${ano}-${mes.padStart(2, '0')}-01`;
    const ultimoDia = new Date(ano, mes, 0).getDate();
    const dataFim = `${ano}-${mes.padStart(2, '0')}-${ultimoDia}`;
    
    Logger.registrar('INFO', '', alias, 
      `Buscando pedidos para pesquisa: ${dataInicio} a ${dataFim}`, {});
    
    // ✅ Dividir mês em semanas ANTES de chamar API
    const todosPedidos = [];
    let dataAtual = new Date(`${dataInicio}T00:00:00`);
    const dataLimite = new Date(`${dataFim}T23:59:59`);
    
    while (dataAtual <= dataLimite) {
      let dataFimSemana = new Date(dataAtual);
      dataFimSemana.setDate(dataFimSemana.getDate() + 6); // 7 dias
      
      if (dataFimSemana > dataLimite) {
        dataFimSemana = new Date(dataLimite);
      }
      
      Logger.registrar('INFO', '', alias, 
        `Semana: ${Utilitarios.formatarData(dataAtual)} até ${Utilitarios.formatarData(dataFimSemana)}`, {});
      
      const pedidosParaAdicionar = YampiAPI.buscarPedidosPorPeriodo(
        alias, token, secretKey,
        Utilitarios.formatarData(dataAtual),
        Utilitarios.formatarData(dataFimSemana)
      );
      
      todosPedidos.push(...pedidosParaAdicionar);
      
      Logger.registrar('SUCESSO', '', alias, 
        `Semana processada: ${pedidosParaAdicionar.length} pedidos`, {});
      
      dataAtual.setDate(dataAtual.getDate() + 7);
      Utilities.sleep(500);
    }
    
    const pedidosUnicos = this.eliminarDuplicacao(todosPedidos);
    
    // ✅ ORDENAR CRONOLOGICAMENTE por created_at
    pedidosUnicos.sort((a, b) => {
      const dataA = new Date(a.created_at);
      const dataB = new Date(b.created_at);
      return dataA - dataB; // Ordem crescente (mais antigo primeiro)
    });
    
    Logger.registrar('SUCESSO', '', alias,
      `Pedidos encontrados para pesquisa: ${pedidosUnicos.length} (ordenados cronologicamente)`, {});
    
    return pedidosUnicos;
    
  } catch (erro) {
    Logger.registrar('ERRO', '', alias,
      `Erro ao buscar pedidos para pesquisa: ${erro.message}`, {});
    throw erro;
  }
},
  
  /**
   * Transforma pedidos para exibição na aba Pesquisa
   */
  transformarPedidosParaPesquisa: function(pedidos, config) {
  return pedidos
    .filter(pedido => {
      const status = Utilitarios.normalizarStatus(pedido.status);
      return Aggregator.isStatusValido(status);
    })
    .map(pedido => {
    const status = Utilitarios.normalizarStatus(pedido.status);
    const dataCriacao = Utilitarios.extrairDataYampi(pedido.created_at);
    const dataAtualizacao = Utilitarios.extrairDataYampi(pedido.updated_at);
    const skus = Utilitarios.concatenarSKUs(pedido.items);
    const nomeCliente = Utilitarios.extrairNomeCliente(pedido.customer);
    
    // ✅ CORREÇÃO: Usar value_products (não value_total)
    const valueProducts = parseFloat(pedido.value_products) || 0;
    const valueShipment = parseFloat(pedido.value_shipment) || 0;
    const valueDiscount = parseFloat(pedido.value_discount) || 0;
    const valueTax = parseFloat(pedido.value_tax) || 0;
    const valueTotal = parseFloat(pedido.value_total) || 0;
    
    const vendaProdutos = valueProducts + valueShipment;
    const valorTotalPago = valueTotal;  // ✅ value_total JÁ é o valor final
    
    return [
      config.nomeEmpresa,
      config.alias,
      pedido.id,
      pedido.number,
      dataCriacao,
      dataAtualizacao,
      status,
      vendaProdutos,
      valueDiscount,
      valueTax,
      valueShipment,
      valorTotalPago,
      skus,
      nomeCliente
    ];
  });
}

};